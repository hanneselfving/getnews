from selenium import webdriver
from selenium.webdriver.common.by import By
import time
from datetime import datetime
import re

# Function to save results to a text file with the current date and time
def save_results_to_file(results):
    now = datetime.now()
    current_time = now.strftime("%Y-%m-%d_%H-%M-%S")
    filename = f"flashback_threads_{current_time}.txt"
    with open(filename, "w", encoding="utf-8") as file:
        file.write("Top 5 Most Read Threads (Sorted by Readers)\n")
        file.write(f"Scraped at: {now}\n\n")
        for index, result in enumerate(results):
            file.write(f"Thread {index + 1}: {result['text']}\n")
    print(f"Results saved to {filename}")

# Set up the WebDriver (assuming Chrome)
driver = webdriver.Chrome()

# Load the Flashback 'Nya Ämnen' page
url = "https://www.flashback.org/nya-amnen"
driver.get(url)

# Wait for the page to load
time.sleep(2)  # Adjust the time if needed for the page to fully load

# Fetch all <tr> elements
rows = driver.find_elements(By.TAG_NAME, 'tr')

# Collect data
results = []
for row in rows:
    # Get all text within the <tr>
    row_text = row.text
    
    # Extract the number of readers (läsare) using a regex
    match = re.search(r'(\d+)\s*läsare', row_text)
    if match:
        readers_count = int(match.group(1))  # Extract the number of readers
    else:
        readers_count = 0  # Default to 0 if no 'läsare' is found
    
    results.append({"text": row_text, "readers": readers_count})

# Sort the results by the number of readers in descending order
results.sort(key=lambda x: x['readers'], reverse=True)

# Save results to a file
save_results_to_file(results)

# Close the driver
driver.quit()
